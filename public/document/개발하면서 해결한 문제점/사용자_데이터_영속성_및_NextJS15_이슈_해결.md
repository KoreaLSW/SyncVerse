# 사용자 데이터 영속성 유지 및 맵 렌더링 이슈 해결

이 문서는 맵 경계 렌더링 문제와 캐릭터 정보 수정 시 발생하는 위치 리셋 버그를 해결하고, 데이터베이스를 이용해 사용자 위치를 영구적으로 저장하는 과정에서 발생한 기술적 문제와 해결 방법을 정리합니다.

## 1. 맵 테두리(Border) 렌더링 이슈

### 문제 상황

-   **현상**: 월드 맵의 상단과 좌측 테두리는 보이지만, 우측과 하단 테두리가 화면에 표시되지 않음.
-   **원인**: 카메라(뷰포트)가 캐릭터를 따라 이동할 때 맵의 끝을 고려하지 않고 중심을 잡으려다 보니, 맵의 우측/하단 끝부분이 화면 밖으로 밀려나 테두리가 잘려 보임.

### 해결 방법

-   **카메라 이동 범위 제한**: `MapCanvas`의 카메라 팔로우 로직에서 `camX`, `camY` 좌표가 맵의 가로/세로 크기를 벗어나지 않도록 제한(Constraint)을 추가했습니다.
-   **CSS 적용**: `worldRef` 요소에 `box-sizing: border-box`를 적용하여 테두리 두께가 맵 크기에 포함되도록 수정했습니다.

---

## 2. 캐릭터 수정 시 위치 리셋 및 동기화 버그

### 문제 상황

1. **위치 리셋**: 캐릭터 외형 수정 후 맵으로 돌아오면 좌표가 (0, 0)으로 초기화됨.
2. **동기화 실패**: 캐릭터 색상을 바꿔도 실시간 환경(Yjs)에 즉시 반영되지 않음.

### 해결 방법

-   **상태 변경 감지**: `MapCanvas`에서 `authStore`의 사용자 정보(`user`) 변경을 감지하는 `useEffect`를 추가하여, 색상 변경 시 즉시 Yjs Map에 업데이트하도록 수정했습니다.
-   **위치 보존**: `setPlayerData` 함수 호출 시 좌표(`x`, `y`)를 명시하지 않으면 기존 데이터를 유지하도록 로직을 보강하여 외형만 바뀔 때 위치가 보존되도록 했습니다.

---

## 3. 사용자 데이터 영속성 구현 (DB 저장)

### 구현 내용

-   **DB 스키마 확장**: `users` 테이블에 `position_x`, `position_y`, `username` 컬럼을 추가했습니다.
-   **저장 전략**:
    1. **주기적 저장**: 5초마다 위치 변화를 감지하여 DB에 기록.
    2. **종료 시 저장**: `beforeunload` 이벤트와 `navigator.sendBeacon`을 사용하여 브라우저를 닫을 때 마지막 위치를 안전하게 저장.
    3. **초기 로드**: 게임 입장 시 DB에서 마지막 위치를 조회하여 해당 좌표에서 시작하도록 구현.

---

## 4. Next.js 15 API 라우트 404/500 에러

### 문제 상황

-   **현상**: DB에 데이터가 존재함에도 불구하고 특정 사용자 조회(`GET /api/users/[username]`) 시 404 에러가 발생하거나, 업데이트(`PATCH`) 시 500 에러가 발생함.
-   **원인**: **Next.js 15** 버전부터 `Route Handler`의 `params`가 더 이상 동기 객체가 아닌 **Promise**로 변경됨. `params.username`을 직접 참조하면 `undefined`가 반환되어 쿼리가 실패함.

### 해결 방법

-   **비동기 처리**: API 핸들러에서 `params`를 `await` 처리하도록 수정했습니다.

```typescript
// Next.js 15 방식
export async function GET(
    request: NextRequest,
    { params }: { params: Promise<{ username: string }> }
) {
    const { username } = await params; // 반드시 await 필요
    // ... 이후 로직
}
```

---

## 5. 결과

-   사용자는 브라우저를 닫았다가 다시 접속해도 마지막으로 있었던 위치에서 게임을 재개할 수 있습니다.
-   캐릭터 수정 페이지를 다녀와도 위치가 유지되며, 변경된 외형이 실시간으로 다른 유저들에게 즉시 반영됩니다.
-   Next.js 15의 변경 사항을 반영하여 API의 안정성을 높였습니다.
